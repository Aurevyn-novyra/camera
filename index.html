<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Lumina Studio | AI Pro Camera</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.0/lucide.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');
        :root { --glass: rgba(15, 15, 15, 0.7); --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; color: #fff; font-family: 'Inter', sans-serif; overflow: hidden; }
        
        #video-canvas { width: 100%; height: 100%; object-fit: cover; display: block; }
        .glass { background: var(--glass); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); }
        
        .shutter-btn { width: 72px; height: 72px; border: 4px solid #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .shutter-btn:active { transform: scale(0.9); }
        .shutter-inner { width: 56px; height: 56px; background: #fff; border-radius: 50%; transition: all 0.3s; }
        .recording .shutter-inner { background: #ff3b30; border-radius: 8px; width: 30px; height: 30px; }

        .ios-toast { animation: toastIn 0.3s ease forwards, toastOut 0.3s ease 2.7s forwards; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; }
        @keyframes toastIn { from { top: -50px; opacity: 0; } to { top: 20px; opacity: 1; } }
        @keyframes toastOut { to { top: -50px; opacity: 0; } }

        .loader { width: 18px; height: 18px; border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        input[type=range] { -webkit-appearance: none; background: rgba(255,255,255,0.1); border-radius: 10px; height: 4px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: #fff; cursor: pointer; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>

    <main class="relative w-full h-full flex flex-col">
        <!-- The Viewfinder -->
        <video id="hidden-video" autoplay playsinline muted class="hidden"></video>
        <canvas id="video-canvas"></canvas>
        
        <!-- Flash Effect -->
        <div id="flash" class="absolute inset-0 bg-white opacity-0 pointer-events-none z-50"></div>

        <!-- Top Controls -->
        <header class="absolute top-0 inset-x-0 p-4 flex justify-between items-center z-40" style="padding-top: calc(1rem + var(--safe-top))">
            <div class="flex gap-2">
                <button onclick="toggleSetting('grid')" class="glass w-10 h-10 rounded-full flex items-center justify-center"><i data-lucide="grid-3x3" class="w-5 h-5"></i></button>
                <button onclick="toggleSetting('timer')" id="timer-btn" class="glass w-10 h-10 rounded-full flex items-center justify-center"><i data-lucide="timer" class="w-5 h-5"></i></button>
            </div>
            
            <div class="flex gap-2">
                <button onclick="analyzeScene()" id="ai-btn" class="glass px-4 py-2 rounded-full flex items-center gap-2 border border-purple-500/40 hover:bg-purple-500/20 transition-colors">
                    <i data-lucide="sparkles" class="w-4 h-4 text-purple-400"></i>
                    <span class="text-[10px] font-bold tracking-widest uppercase" id="ai-btn-text">✨ AI Director</span>
                </button>
                <button onclick="describeScene()" id="speak-btn" class="glass w-10 h-10 rounded-full flex items-center justify-center border border-blue-500/40">
                    <i data-lucide="volume-2" class="w-5 h-5 text-blue-400"></i>
                </button>
            </div>

            <div class="flex gap-2">
                <button onclick="switchCamera()" class="glass w-10 h-10 rounded-full flex items-center justify-center"><i data-lucide="refresh-cw" class="w-5 h-5"></i></button>
            </div>
        </header>

        <!-- Overlays -->
        <div id="grid" class="absolute inset-0 pointer-events-none grid grid-cols-3 grid-rows-3 hidden opacity-30">
            <div class="border border-white/50"></div><div class="border border-white/50"></div><div class="border border-white/50"></div>
            <div class="border border-white/50"></div><div class="border border-white/50"></div><div class="border border-white/50"></div>
            <div class="border border-white/50"></div><div class="border border-white/50"></div><div class="border border-white/50"></div>
        </div>

        <!-- AI Insight Box -->
        <div id="ai-box" class="absolute top-24 inset-x-4 glass p-4 rounded-2xl hidden z-40 animate-in slide-in-from-top duration-300">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <i data-lucide="brain-circuit" class="w-4 h-4 text-purple-400"></i>
                    <span class="text-[10px] font-bold text-purple-400 uppercase tracking-tighter">Gemini Scene Director</span>
                </div>
                <button onclick="document.getElementById('ai-box').classList.add('hidden')"><i data-lucide="x" class="w-4 h-4 opacity-50"></i></button>
            </div>
            <p id="ai-text" class="text-sm font-medium leading-relaxed text-white/90"></p>
        </div>

        <!-- Zoom Slider -->
        <div class="absolute right-4 top-1/2 -translate-y-1/2 flex flex-col items-center gap-4 z-40">
            <div class="h-48 w-12 glass rounded-full flex flex-col items-center justify-between py-4">
                <span class="text-[10px] font-bold opacity-50">3X</span>
                <div class="flex-1 w-full flex items-center justify-center">
                    <input type="range" id="zoom" min="1" max="3" step="0.1" value="1" style="writing-mode: vertical-lr; direction: rtl; width: 100px; height: 8px;">
                </div>
                <span class="text-[10px] font-bold text-white" id="zoom-val">1.0X</span>
            </div>
        </div>

        <!-- Bottom Controls -->
        <footer class="absolute bottom-0 inset-x-0 p-8 flex flex-col items-center z-40" style="padding-bottom: calc(2rem + var(--safe-bottom))">
            
            <div class="w-full flex justify-center gap-6 mb-6 text-[11px] font-bold uppercase tracking-widest text-white/40">
                <button onclick="setMode('PHOTO')" id="m-photo" class="text-white transition-colors">Photo</button>
                <button onclick="setMode('VIDEO')" id="m-video" class="transition-colors">Video</button>
                <button onclick="setMode('REMIX')" id="m-remix" class="flex items-center gap-1 transition-colors border-b-2 border-transparent"><i data-lucide="wand-2" class="w-3 h-3"></i> ✨ Remix</button>
            </div>

            <div class="flex items-center gap-12">
                <button id="gallery" onclick="openGallery()" class="w-12 h-12 glass rounded-xl overflow-hidden flex items-center justify-center group">
                    <i data-lucide="image" class="w-5 h-5 text-white/50 group-hover:text-white transition-colors"></i>
                </button>

                <button id="shutter-parent" onclick="handleCapture()" class="shutter-btn group">
                    <div id="shutter-dot" class="shutter-inner group-hover:scale-95 transition-transform"></div>
                </button>

                <button onclick="togglePanel()" class="w-12 h-12 glass rounded-full flex items-center justify-center hover:bg-white/10">
                    <i data-lucide="sliders-horizontal" class="w-5 h-5"></i>
                </button>
            </div>
        </footer>

        <!-- Pro Settings Panel -->
        <div id="pro-panel" class="absolute inset-x-0 bottom-0 glass rounded-t-[40px] p-8 translate-y-full transition-transform duration-500 z-50">
            <div class="w-12 h-1.5 bg-white/20 rounded-full mx-auto mb-8" onclick="togglePanel()"></div>
            <div class="space-y-6 max-w-md mx-auto">
                <div class="space-y-2">
                    <div class="flex justify-between text-[10px] font-bold uppercase"><span>Exposure</span><span id="v-exp">0</span></div>
                    <input type="range" class="w-full" oninput="updateVal('brightness', this.value, 'v-exp')" min="-100" max="100" value="0">
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-[10px] font-bold uppercase"><span>Saturation</span><span id="v-sat">0</span></div>
                    <input type="range" class="w-full" oninput="updateVal('saturate', this.value, 'v-sat')" min="-100" max="100" value="0">
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between text-[10px] font-bold uppercase"><span>Preset Filters</span></div>
                    <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                        <button onclick="setFilter('none')" class="shrink-0 px-4 py-2 glass rounded-full text-[10px] uppercase">Original</button>
                        <button onclick="setFilter('vivid')" class="shrink-0 px-4 py-2 glass rounded-full text-[10px] uppercase bg-blue-500/20">Vivid</button>
                        <button onclick="setFilter('noir')" class="shrink-0 px-4 py-2 glass rounded-full text-[10px] uppercase bg-zinc-500/20">Noir</button>
                        <button onclick="setFilter('retro')" class="shrink-0 px-4 py-2 glass rounded-full text-[10px] uppercase bg-orange-500/20">Retro</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="toasts"></div>

    <script>
        const apiKey = ""; // Provided at runtime
        const video = document.getElementById('hidden-video');
        const canvas = document.getElementById('video-canvas');
        const ctx = canvas.getContext('2d', { alpha: false, desynchronized: true });
        
        let state = {
            mode: 'PHOTO',
            facing: 'environment',
            zoom: 1,
            filters: { brightness: 100, saturate: 100, contrast: 100 },
            activeFilter: 'none',
            isRecording: false,
            timer: 0,
            lastFrame: null,
            isRemixing: false
        };

        let mediaRecorder, chunks = [], stream;

        // --- Initialization ---
        async function init() {
            try {
                if (stream) stream.getTracks().forEach(t => t.stop());
                
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: state.facing, width: { ideal: 1920 }, height: { ideal: 1080 } },
                    audio: true
                });
                
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    requestAnimationFrame(loop);
                };
            } catch (err) {
                toast("Camera access denied", "alert-triangle");
            }
        }

        function loop() {
            if (!video.videoWidth) return requestAnimationFrame(loop);

            const f = state.filters;
            let filterStr = `brightness(${f.brightness}%) saturate(${f.saturate}%) contrast(${f.contrast}%)`;
            
            if (state.activeFilter === 'vivid') filterStr += ' saturate(150%) contrast(110%)';
            if (state.activeFilter === 'noir') filterStr += ' grayscale(100%) contrast(120%)';
            if (state.activeFilter === 'retro') filterStr += ' sepia(40%) contrast(90%) brightness(110%)';

            ctx.filter = filterStr;

            const z = state.zoom;
            const sw = canvas.width / z;
            const sh = canvas.height / z;
            const sx = (canvas.width - sw) / 2;
            const sy = (canvas.height - sh) / 2;

            ctx.drawImage(video, sx, sy, sw, sh, 0, 0, canvas.width, canvas.height);
            requestAnimationFrame(loop);
        }

        // --- Core UI Actions ---
        function handleCapture() {
            if (state.mode === 'VIDEO') toggleVideo();
            else if (state.mode === 'REMIX') remixImage();
            else takePhoto();
        }

        function takePhoto() {
            if (state.timer > 0) {
                toast(`Timer: ${state.timer}s`, 'clock');
                setTimeout(captureImage, state.timer * 1000);
            } else captureImage();
        }

        function captureImage() {
            const flash = document.getElementById('flash');
            flash.style.opacity = '1';
            setTimeout(() => flash.style.opacity = '0', 100);

            const data = canvas.toDataURL('image/jpeg', 0.9);
            state.lastFrame = data;
            saveMedia(data, 'jpg');
            toast("Photo saved to gallery", "check-circle");
        }

        function toggleVideo() {
            if (!state.isRecording) {
                chunks = [];
                const vStream = canvas.captureStream(30);
                mediaRecorder = new MediaRecorder(vStream, { mimeType: 'video/webm' });
                mediaRecorder.ondataavailable = e => chunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    saveMedia(URL.createObjectURL(blob), 'webm');
                };
                mediaRecorder.start();
                state.isRecording = true;
                document.getElementById('shutter-parent').classList.add('recording');
                toast("Recording started", "video");
            } else {
                mediaRecorder.stop();
                state.isRecording = false;
                document.getElementById('shutter-parent').classList.remove('recording');
                toast("Video saved", "check-circle");
            }
        }

        // --- ✨ Gemini LLM Integrations ---

        // 1. ✨ AI Scene Director: Analyzes visual context & suggests settings
        async function analyzeScene() {
            const btn = document.getElementById('ai-btn');
            const txt = document.getElementById('ai-btn-text');
            btn.classList.add('opacity-50', 'pointer-events-none');
            txt.innerHTML = '<span class="loader"></span> Analyzing...';

            try {
                const img = canvas.toDataURL('image/jpeg', 0.5).split(',')[1];
                const res = await callGemini("gemini-2.5-flash-preview-09-2025", {
                    contents: [{ 
                        parts: [
                            { text: "Act as a pro photographer. Analyze this scene. Suggest settings (JSON format). {advice: string (max 12 words), brightness_adj: number (-50 to 50), saturate_adj: number (-50 to 50), filter: 'vivid'|'noir'|'retro'|'none'}" }, 
                            { inlineData: { mimeType: "image/jpeg", data: img } }
                        ] 
                    }],
                    generationConfig: { responseMimeType: "application/json" }
                });

                const data = JSON.parse(res.candidates[0].content.parts[0].text);
                
                // Show advice box
                document.getElementById('ai-text').innerText = data.advice;
                document.getElementById('ai-box').classList.remove('hidden');
                
                // Auto-apply suggested pro settings
                updateVal('brightness', data.brightness_adj, 'v-exp');
                updateVal('saturate', data.saturate_adj, 'v-sat');
                setFilter(data.filter);
                
                toast("✨ Director settings applied", "sparkles");
            } catch (e) {
                toast("AI Director unavailable", "cloud-off");
            } finally {
                btn.classList.remove('opacity-50', 'pointer-events-none');
                txt.innerText = "✨ AI Director";
            }
        }

        // 2. ✨ Magic Remix: Uses Image-to-Image to stylized captured frames
        async function remixImage() {
            if (!state.lastFrame) return toast("Take a photo first!", "camera");
            if (state.isRemixing) return;
            
            state.isRemixing = true;
            toast("✨ Gemini is remixing...", "sparkles");
            
            try {
                const img = state.lastFrame.split(',')[1];
                const res = await callGeminiImage("gemini-2.5-flash-image-preview", {
                    contents: [{ 
                        parts: [
                            { text: "Transform this photo into a cinematic, high-detail cyberpunk neon aesthetic while keeping the main subjects recognizable." }, 
                            { inlineData: { mimeType: "image/jpeg", data: img } }
                        ] 
                    }],
                    generationConfig: { responseModalities: ['IMAGE'] }
                });

                const base64 = res.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                if (base64) {
                    saveMedia(`data:image/png;base64,${base64}`, 'png');
                    toast("✨ Remix saved!", "wand");
                }
            } catch (e) {
                toast("Remix failed", "alert-circle");
            } finally {
                state.isRemixing = false;
            }
        }

        // 3. ✨ Audio Narrator: Gemini TTS describes the world
        async function describeScene() {
            const btn = document.getElementById('speak-btn');
            btn.classList.add('animate-pulse', 'pointer-events-none');
            toast("✨ Gemini is observing...", "eye");

            try {
                // First, get text description
                const img = canvas.toDataURL('image/jpeg', 0.3).split(',')[1];
                const textRes = await callGemini("gemini-2.5-flash-preview-09-2025", {
                    contents: [{ 
                        parts: [
                            { text: "Describe this scene briefly in one poetic sentence for an audio narrator." }, 
                            { inlineData: { mimeType: "image/jpeg", data: img } }
                        ] 
                    }]
                });
                
                const description = textRes.candidates[0].content.parts[0].text;
                
                // Then, convert to speech
                const ttsRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Say smoothly: ${description}` }] }],
                        generationConfig: { 
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } }
                        }
                    })
                });
                
                const ttsData = await ttsRes.json();
                const pcmData = ttsData.candidates[0].content.parts[0].inlineData.data;
                playPCM(pcmData);
                toast(description, "volume-2");
            } catch (e) {
                toast("Speech failed", "volume-x");
            } finally {
                btn.classList.remove('animate-pulse', 'pointer-events-none');
            }
        }

        // Helper: Play Gemini PCM Audio
        async function playPCM(base64) {
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
            
            // Create a WAV header for the PCM16 data
            const sampleRate = 24000; 
            const wavHeader = createWavHeader(bytes.length, sampleRate);
            const blob = new Blob([wavHeader, bytes], { type: 'audio/wav' });
            const audio = new Audio(URL.createObjectURL(blob));
            audio.play();
        }

        function createWavHeader(dataLength, sampleRate) {
            const buffer = new ArrayBuffer(44);
            const view = new DataView(buffer);
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
            };
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // PCM
            view.setUint16(22, 1, true); // Mono
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, dataLength, true);
            return buffer;
        }

        async function callGemini(model, payload) {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error('API Error');
            return res.json();
        }

        async function callGeminiImage(model, payload) {
            // Placeholder for the supported image-to-image endpoint
            return callGemini(model, payload);
        }

        // --- Standard UI Helpers ---
        function toast(m, icon) {
            const t = document.createElement('div');
            t.className = 'glass px-6 py-3 rounded-full flex items-center gap-3 ios-toast shadow-2xl z-[100]';
            t.innerHTML = `<i data-lucide="${icon || 'info'}" class="w-4 h-4"></i><span class="text-xs font-medium">${m}</span>`;
            document.getElementById('toasts').appendChild(t);
            if (window.lucide) lucide.createIcons();
            setTimeout(() => t.remove(), 3200);
        }

        function saveMedia(url, ext) {
            const a = document.createElement('a');
            a.href = url;
            a.download = `Lumina_${Date.now()}.${ext}`;
            a.click();
            document.getElementById('gallery').innerHTML = `<img src="${url}" class="w-full h-full object-cover">`;
        }

        function updateVal(key, val, id) {
            state.filters[key] = 100 + parseInt(val);
            const display = document.getElementById(id);
            if (display) display.innerText = (val > 0 ? '+' : '') + val;
        }

        function toggleSetting(type) {
            if (type === 'grid') document.getElementById('grid').classList.toggle('hidden');
            if (type === 'timer') {
                state.timer = state.timer === 0 ? 3 : (state.timer === 3 ? 10 : 0);
                document.getElementById('timer-btn').innerHTML = state.timer > 0 ? `<span class="text-[10px] font-bold">${state.timer}s</span>` : `<i data-lucide="timer" class="w-5 h-5"></i>`;
                if (window.lucide) lucide.createIcons();
            }
        }

        function setMode(m) {
            state.mode = m;
            ['PHOTO', 'VIDEO', 'REMIX'].forEach(x => {
                const el = document.getElementById(`m-${x.toLowerCase()}`);
                el.className = x === m ? 'text-white border-b-2 border-white pb-1' : 'text-white/40';
            });
            toast(`Mode: ${m}`, m === 'REMIX' ? 'wand-2' : (m === 'VIDEO' ? 'video' : 'camera'));
        }

        function setFilter(f) { 
            state.activeFilter = f; 
            if (f !== 'none') toast(`Filter: ${f}`, 'palette'); 
        }

        function switchCamera() { 
            state.facing = state.facing === 'user' ? 'environment' : 'user'; 
            init(); 
            toast("Camera Switched", "refresh-cw");
        }

        function togglePanel() { 
            document.getElementById('pro-panel').classList.toggle('translate-y-full'); 
        }

        function openGallery() { toast("Gallery saved to local storage"); }

        document.getElementById('zoom').oninput = (e) => {
            state.zoom = parseFloat(e.target.value);
            document.getElementById('zoom-val').innerText = state.zoom.toFixed(1) + 'X';
        };

        window.onload = () => {
            const checkLucide = setInterval(() => {
                if (typeof lucide !== 'undefined') {
                    clearInterval(checkLucide);
                    lucide.createIcons();
                    init();
                }
            }, 100);
            setTimeout(() => { clearInterval(checkLucide); init(); }, 2000);
        };
    </script>
</body>
</html>
